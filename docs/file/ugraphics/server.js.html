<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">ugraphics/server.js | ugraphics</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LoadConfig">LoadConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emitSynf">emitSynf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emitTrigger">emitTrigger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handleSocket">handleSocket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setTick">setTick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Styl">Styl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-router">router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-app">app</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-io">io</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logger">logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-server">server</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CWD">CWD</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Config">Config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Debug">Debug</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dataStore">dataStore</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-js-cg">core/js/cg</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ugraphics/core/js/cg/cgcontroller.js~CGController.html">CGController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cgAnimate">cgAnimate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cgsetup">cgsetup</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-js-cg-modules">core/js/cg/modules</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clock">clock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-timer">timer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-js-dash">core/js/dash</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ugraphics/core/js/dash/dashcontroller.js~DashController.html">DashController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dashsetup">dashsetup</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-js-dash-modules">core/js/dash/modules</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-queue">queue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-timer">timer</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">ugraphics/server.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// -----------------------------------------------------------------------------
// - IMPORTS -------------------------------------------------------------------
// -----------------------------------------------------------------------------
console.log(&apos;Server entry point&apos;);
import * as Shared from &apos;./shared&apos;;

// Import modules from npm/node
import Path from &apos;path&apos;;
import FS from &apos;fs&apos;;
import HTTP from &apos;http&apos;;
import Express from &apos;express&apos;;
import Yargs from &apos;yargs&apos;;
import Winston from &apos;winston&apos;;
import SocketIOServer from &apos;socket.io&apos;;
import Moment from &apos;moment&apos;;
import _ from &apos;lodash&apos;;
import Vorpal from &apos;vorpal&apos;;
import &apos;pug&apos;; // So that pkg works

// Import config and modules from project
import DashRouter from &apos;./dashrouter&apos;;
import * as StylesheetMiddleware from &apos;./stylesheet&apos;;
import * as SocketHandler from &apos;./socketHandler&apos;;

// -----------------------------------------------------------------------------
// - SERVER OPTIONS ------------------------------------------------------------
// -----------------------------------------------------------------------------
console.log(&apos;Imports complete, configuring Winston&apos;);
let consoleTransport = new Winston.transports.Console({
    format: Winston.format.combine(
        Winston.format.colorize(),
        Winston.format.printf(info =&gt; `${info.level}: ${info.message}`))
});
export let logger = Winston.createLogger({
    transports: [ consoleTransport ],
    level: Shared.Debug? &apos;silly&apos; : &apos;info&apos;
});

// Parse command line options with Yargs, taking defaults from config.json
logger.silly(`Parsing command-line options`);
/** The command-line arguments as read in with Yargs */
let argv = Yargs
    .option(&apos;config&apos;, {
        alias: &apos;c&apos;,
        describe: &apos;The config file to load&apos;,
        type: &apos;string&apos;
    })
    .option(&apos;port&apos;, {
        alias: &apos;p&apos;,
        describe: &apos;Port to listen on&apos;,
        type: &apos;number&apos;
    })
    .default({
        port: 3000,
        config: &apos;config.json&apos;
    })
    .usage(`Forge Graphics Server \nUsage: $0 [-c config] [-p port]`)
    .help().alias(&apos;h&apos;, &apos;help&apos;)
    .argv;

Shared.LoadConfig(argv.config);

logger.info(`Forge Graphics Server Gen3 (${Shared.Config.locals.product} - ${Shared.Config.locals.project})`)
logger.info(`Time of start: ${Moment().format(&apos;ddd DD MMM YYYY, HH:mm:ss ZZ&apos;)}`)

// -----------------------------------------------------------------------------
// - EXPRESS APP ---------------------------------------------------------------
// -----------------------------------------------------------------------------
// Create an Express app, using Pug as the view engine
logger.silly(`Configuring Express app`);
/** The Express app powering the dashboard and character generator */
export let app = Express();
/** The HTTP server that serves up {@link app} */
export let server = HTTP.createServer(app);
app.set(&apos;views&apos;, Shared.Config.viewDirectories);
app.set(&apos;view engine&apos;, &apos;pug&apos;);
app.set(&apos;view options&apos;, { debug: false });
app.locals = _.assign(Shared.Config.locals, { ugr_debug: Shared.Debug, basedir: Shared.CWD });

// Pass the app to functions that install middleware which processes SCSS
// and Stylus stylesheets on-demand
logger.silly(`Configuring Stylus middleware`);
StylesheetMiddleware.Styl(app);

// -----------------------------------------------------------------------------
// - SERVER --------------------------------------------------------------------
// -----------------------------------------------------------------------------
// Serve static directories
logger.silly(`Configuring server routes`);
for (let pub in Shared.Config.publicDirs)
    for (let dir of Shared.Config.publicDirs[pub])
        app.use(`/${pub}`,
            Express.static(Path.join(Shared.CWD, dir)));

// Use the dashboard router module to handle the dashboard view
app.use([&apos;/dash&apos;, &apos;/dashboard&apos;], DashRouter);

// Render the character generator when / is accessed
app.get(&apos;/&apos;, (req, res) =&gt; res.render(&apos;cg/index&apos;));

// Handle anything else by sending a 404 error page and a 404 status code
app.get(&apos;*&apos;, (req, res) =&gt; res.status(404).render(&apos;404&apos;));

// -----------------------------------------------------------------------------
// - SOCKET.IO REAL-TIME COMMS -------------------------------------------------
// -----------------------------------------------------------------------------
logger.silly(`Configuring socket.io server`);
/** The socket.io real-time communications server */
export let io = SocketIOServer(server, {
    wsEngine: &quot;ws&quot;
});

// Start the Express app listening on the specified port
server.listen(argv.port, () =&gt; {
    // Log some stuff
    logger.info(`Listening on port ${argv.port}`);
    logger.debug(&apos;Debug enabled&apos;);

    // On any connection, handle it with the function defined in socketHandler.ts
    io.on(&apos;connection&apos;, SocketHandler.handleSocket);

    SocketHandler.setTick();
});

// -----------------------------------------------------------------------------
// - VORPAL COMMAND-LINE INTERFACE ---------------------------------------------
// -----------------------------------------------------------------------------
let vorpal = Vorpal();

vorpal.command(&apos;show &lt;store&gt;&apos;)
    .description(&apos;Show the contents of a module\&apos;s data store&apos;)
    .alias(&apos;s&apos;)
    .action((args, callback) =&gt; {
        console.log(JSON.stringify(SocketHandler.dataStore[args.store] || &apos;Module not found&apos; ));
        callback();
    });

vorpal.delimiter(&apos;uGraphics&gt;&apos;).show();
consoleTransport.on(&apos;logged&apos;, () =&gt; vorpal.ui.redraw.done());
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
